{% extends "recursos/base.html" %}
{% load auth_extras %}

{% block page_styles %}
<style>
    :root {
        --sidebar-width: 280px;
        --uteq-green: #00693E;
    }
    body {
        background-color: #f8f9fa;
    }
    .main-content {
        transition: margin-left .3s ease;
    }
    .top-header {
        background-color: #fff;
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid #dee2e6;
        height: 70px;
    }
    .offcanvas.offcanvas-start {
        width: var(--sidebar-width);
        background-color: var(--uteq-green);
        color: #fff;
    }
    .offcanvas .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        font-size: 1.05rem;
    }
    .offcanvas .nav-link:hover, .offcanvas .nav-link.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
    }
    .offcanvas-title {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .sidebar-footer {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
    }

    /* Estilos para pantallas grandes (menú lateral visible) */
    @media (min-width: 992px) {
        .main-content {
            margin-left: var(--sidebar-width);
        }
        .offcanvas.offcanvas-start {
            transform: none;
            visibility: visible !important;
            top: 0;
            position: fixed;
            height: 100vh;
        }
        .offcanvas-backdrop {
            display: none;
        }
    }
</style>
{% endblock %}


{% block body_content %}
    <!-- MENÚ LATERAL (AHORA OFFCANVAS DE BOOTSTRAP) -->
    <aside class="sidebar offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">
                <i class="bi bi-cpu"></i> Directorio de IAs
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>

        <div class="offcanvas-body d-flex flex-column p-0">
            <ul class="nav flex-column mb-auto p-3">
                <li class="nav-item"><a href="{% url 'recursos:dashboard' %}" class="nav-link"><i class="bi bi-house-door-fill me-2"></i>Dashboard</a></li>
                {% if user.is_authenticated and user.perfil %}
                <li class="nav-item"><a href="{% url 'recursos:favorite_resources_list' %}" class="nav-link"><i class="bi bi-star-fill me-2"></i>Mis Favoritos</a></li>
                {% endif %}

                {# --- Lógica de Navegación por Rol --- #}
                {% if user.is_staff or user.is_superuser %}
                    <li class="nav-item"><a href="{% url 'recursos:career_list' %}" class="nav-link"><i class="bi bi-journals me-2"></i>Todas las Carreras</a></li>
                {% else %}
                    {% if user.perfil.carrera %}
                    <li class="nav-item"><a href="{% url 'recursos:resource_type_list' pk=user.perfil.carrera.pk %}" class="nav-link"><i class="bi bi-collection-fill me-2"></i>Mis Recursos</a></li>
                    {% endif %}
                {% endif %}

                {% if user|in_group:"Docente" or user.is_superuser %}
                <li class="nav-item"><a href="{% url 'recursos:sugerir_recurso' %}" class="nav-link"><i class="bi bi-lightbulb me-2"></i>Sugerir Recurso</a></li>
                {% endif %}

                {% if user.is_staff %}
                <li class="nav-item mt-4"><small class="text-uppercase px-1" style="color: rgba(255,255,255,0.4); font-weight: bold;">Gestión</small></li>
                {% if perms.auth.view_user %}<li class="nav-item"><a href="/admin/auth/user/" class="nav-link"><i class="bi bi-people-fill me-2"></i>Usuarios</a></li>{% endif %}
                {% if perms.recursos.view_carrera %}<li class="nav-item"><a href="/admin/recursos/carrera/" class="nav-link"><i class="bi bi-journal-bookmark-fill me-2"></i>Carreras</a></li>{% endif %}
                {% if perms.recursos.view_recurso %}<li class="nav-item"><a href="/admin/recursos/recurso/" class="nav-link"><i class="bi bi-tools me-2"></i>Recursos</a></li>{% endif %}
                {% endif %}
            </ul>

            <div class="sidebar-footer p-3">
                <hr style="color: rgba(255,255,255,0.2);">
                UTEQ © 2025
            </div>
        </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">
        <!-- HEADER SUPERIOR -->
        <header class="top-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <button class="btn d-lg-none me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
                    <i class="bi bi-list fs-3"></i>
                </button>
                <a href="{% url 'recursos:home' %}">
                    <img src="https://univercimas.com/wp-content/uploads/2021/04/Logo-de-la-Universidad-Tecnica-Estatal-de-Quevedo-UTEQ-1.png" alt="Logo UTEQ" style="height: 40px;">
                </a>
            </div>

            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle me-2"></i>
                    {{ user.first_name|default:user.username }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="#">Mi Perfil</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form method="post" action="{% url 'logout' %}" class="m-0">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item text-danger">
                                <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </header>

        <!-- Contenedor para el contenido de la página -->
        <main class="p-4">
            {% block content %}{% endblock %}
        </main>
    </div>
{% endblock %}


{% block page_scripts %}
<script>
    // El código para el Offcanvas de Bootstrap ya está incluido en el bundle de Bootstrap.
    // No se necesita JavaScript adicional aquí para el menú lateral.
</script>
{% endblock %}