{% extends "recursos/base.html" %}
{% load auth_extras %}

{% block page_styles %}
<style>
    body {
        background-color: #f8f9fa; /* Fondo gris claro para el área de contenido */
    }
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: var(--sidebar-width, 280px);
        background-color: var(--uteq-green, #00693E);
        color: #fff;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        z-index: 1050;
        transition: transform 0.3s ease-in-out;
    }
    .main-content {
        margin-left: var(--sidebar-width, 280px);
        padding: 0;
    }
    .top-header {
        background-color: #fff;
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid #dee2e6;
        height: 70px; /* Altura fija para el header */
    }
    .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        font-size: 1.05rem;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
    }
    .sidebar-header {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 2rem;
        text-align: center;
    }
    .sidebar-footer {
        margin-top: auto;
        font-size: 0.8rem;
        text-align: center;
        color: rgba(255, 255, 255, 0.5);
    }
    /* Responsive */
    @media (max-width: 991.98px) {
        .sidebar {
            transform: translateX(-100%);
        }
        .sidebar.is-open {
            transform: translateX(0);
        }
        .main-content {
            margin-left: 0;
        }
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1049;
            display: none;
        }
        .sidebar.is-open ~ .sidebar-overlay {
            display: block;
        }
    }
</style>
{% endblock %}


{% block body_content %}
    <!-- MENÚ LATERAL FIJO -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-cpu"></i> Directorio de IAs
        </div>
        
        <ul class="nav flex-column mb-auto">
            <li class="nav-item"><a href="{% url 'recursos:dashboard' %}" class="nav-link"><i class="bi bi-house-door-fill me-2"></i>Dashboard</a></li>
            {% if user.is_authenticated and user.perfil %}
            <li class="nav-item"><a href="{% url 'recursos:favorite_resources_list' %}" class="nav-link"><i class="bi bi-star-fill me-2"></i>Mis Favoritos</a></li>
            {% endif %}
            
            {# --- Lógica de Navegación por Rol --- #}
            {% if user.is_staff or user.is_superuser %}
                {# Para Admins/Gestores, mostramos la lista de todas las carreras #}
                <li class="nav-item"><a href="{% url 'recursos:career_list' %}" class="nav-link"><i class="bi bi-journals me-2"></i>Todas las Carreras</a></li>
            {% else %}
                {# Para Estudiantes/Docentes, mostramos un enlace directo a los recursos de SU carrera #}
                {% if user.perfil.carrera %}
                <li class="nav-item"><a href="{% url 'recursos:resource_type_list' pk=user.perfil.carrera.pk %}" class="nav-link"><i class="bi bi-collection-fill me-2"></i>Mis Recursos</a></li>
                {% endif %}
            {% endif %}

            {% if user|in_group:"Docente" or user.is_superuser %}
            <li class="nav-item"><a href="{% url 'recursos:sugerir_recurso' %}" class="nav-link"><i class="bi bi-lightbulb me-2"></i>Sugerir Recurso</a></li>
            {% endif %}
            
            {% if user.is_staff %}
            <li class="nav-item mt-4"><small class="text-uppercase px-1" style="color: rgba(255,255,255,0.4); font-weight: bold;">Gestión</small></li>
            {% if perms.auth.view_user %}<li class="nav-item"><a href="/admin/auth/user/" class="nav-link"><i class="bi bi-people-fill me-2"></i>Usuarios</a></li>{% endif %}
            {% if perms.recursos.view_carrera %}<li class="nav-item"><a href="/admin/recursos/carrera/" class="nav-link"><i class="bi bi-journal-bookmark-fill me-2"></i>Carreras</a></li>{% endif %}
            {% if perms.recursos.view_recurso %}<li class="nav-item"><a href="/admin/recursos/recurso/" class="nav-link"><i class="bi bi-tools me-2"></i>Recursos</a></li>{% endif %}
            {% endif %}
        </ul>
        
        <div class="sidebar-footer">
            <hr style="color: rgba(255,255,255,0.2);">
            UTEQ © 2025
        </div>
    </aside>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">
        <!-- HEADER SUPERIOR -->
        <header class="top-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <button class="btn d-lg-none me-2" type="button" onclick="toggleSidebar()">
                    <i class="bi bi-list fs-3"></i>
                </button>
                <a href="{% url 'recursos:home' %}">
                    <img src="https://univercimas.com/wp-content/uploads/2021/04/Logo-de-la-Universidad-Tecnica-Estatal-de-Quevedo-UTEQ-1.png" alt="Logo UTEQ" style="height: 40px;">
                </a>
            </div>
            
            <div class="user-menu">
                {% if user.is_authenticated %}
                <div class="dropdown">
                    <a href="#" class="d-block link-dark text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle fs-3 me-2"></i>
                        <span class="d-none d-sm-inline">{{ user.first_name|default:user.username }}</span>
                    </a>
                    <ul class="dropdown-menu text-small dropdown-menu-end" aria-labelledby="dropdownUser1">
                        <li><a class="dropdown-item" href="#">Mi Perfil</a></li>
                        <li><a class="dropdown-item" href="#">Cambio de clave</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form method="post" action="{% url 'logout' %}" class="m-0">
                                {% csrf_token %}
                                <button type="submit" class="dropdown-item w-100 text-start">
                                    <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </header>

        <!-- CONTENEDOR CENTRAL DE LA PÁGINA -->
        <main class="p-4">
            {% block content %}
            {# El contenido específico de la página (ej: dashboard.html) irá aquí #}
            {% endblock %}
        </main>
    </div>
{% endblock %}

{% block page_scripts %}
<script>
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('is-open');
    }
</script>
{% endblock %}